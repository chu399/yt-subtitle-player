import React, { useState, useEffect, useRef } from 'react';
import { Play, Pause, Square, Volume2, Settings, List, Download, ArrowRight, BookOpen, Clock, RefreshCw } from 'lucide-react';

const App = () => {
  const [text, setText] = useState("æ­¡è¿ä½¿ç”¨é›»å­æ›¸æœ—è®€å·¥å…·ã€‚å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ Microsoft Edge ç€è¦½å™¨ï¼Œæ‚¨å¯ä»¥åœ¨ä¸‹æ–¹çš„é¸å–®ä¸­æ‰¾åˆ°é«˜å“è³ªçš„ã€ŒMicrosoft Onlineã€å°ç£èªéŸ³ï¼ˆå¦‚æ›‰è‡»ã€é›²å“²ï¼‰ã€‚é€™é¡èªéŸ³è½èµ·ä¾†éå¸¸è‡ªç„¶ï¼Œä¸”å®Œå…¨å…è²»ï¼Œéå¸¸é©åˆç”¨ä¾†æœ—è®€é•·ç¯‡å°èªªã€‚");
  const [voices, setVoices] = useState([]);
  const [selectedVoiceName, setSelectedVoiceName] = useState("");
  const [rate, setRate] = useState(1);
  const [pitch, setPitch] = useState(1);
  const [isPlaying, setIsPlaying] = useState(false);
  const [isPaused, setIsPaused] = useState(false);
  const [currentSentenceIndex, setCurrentSentenceIndex] = useState(0);
  const [sentences, setSentences] = useState([]);
  
  const synth = window.speechSynthesis;
  const utteranceRef = useRef(null);

  // åˆå§‹åŒ–èªéŸ³æ¸…å–®
  const loadVoices = () => {
    const availableVoices = synth.getVoices();
    // å„ªå…ˆéæ¿¾å‡ºå°ç£ä¸­æ–‡èˆ‡å¾®è»Ÿç·šä¸ŠèªéŸ³
    const filteredVoices = availableVoices.filter(v => v.lang.includes('zh-TW') || v.lang.includes('zh-HK'));
    setVoices(availableVoices);
    
    // é è¨­é¸æ“‡æ›‰è‡» (HsiaoChen) æˆ–é›²å“² (Yunjhe)
    const defaultVoice = availableVoices.find(v => v.name.includes('HsiaoChen') || v.name.includes('æ›‰è‡»')) || 
                        availableVoices.find(v => v.name.includes('zh-TW')) ||
                        availableVoices[0];
    
    if (defaultVoice && !selectedVoiceName) {
      setSelectedVoiceName(defaultVoice.name);
    }
  };

  useEffect(() => {
    loadVoices();
    if (synth.onvoiceschanged !== undefined) {
      synth.onvoiceschanged = loadVoices;
    }
    return () => {
      synth.cancel();
    };
  }, []);

  // æ–·å¥é‚è¼¯ï¼šé‡å°é›»å­æ›¸å„ªåŒ–
  const splitIntoSentences = (rawText) => {
    return rawText
      .split(/([ã€‚ï¼ï¼Ÿï¼›\n])/)
      .reduce((acc, curr, idx) => {
        if (idx % 2 === 0) {
          if (curr.trim()) acc.push(curr);
        } else {
          if (acc.length > 0) acc[acc.length - 1] += curr;
        }
        return acc;
      }, []);
  };

  const speakSentence = (index) => {
    if (index >= sentences.length) {
      handleStop();
      return;
    }

    const utterance = new SpeechSynthesisUtterance(sentences[index]);
    const voice = voices.find(v => v.name === selectedVoiceName);
    if (voice) utterance.voice = voice;
    
    utterance.rate = rate;
    utterance.pitch = pitch;

    utterance.onstart = () => {
      setCurrentSentenceIndex(index);
      setIsPlaying(true);
      setIsPaused(false);
    };

    utterance.onend = () => {
      if (!isPaused) {
        speakSentence(index + 1);
      }
    };

    utterance.onerror = (event) => {
      console.error("SpeechSynthesisUtterance Error:", event);
      handleStop();
    };

    utteranceRef.current = utterance;
    synth.speak(utterance);
  };

  const handlePlay = () => {
    if (isPaused) {
      synth.resume();
      setIsPaused(false);
      setIsPlaying(true);
    } else {
      synth.cancel();
      const newSentences = splitIntoSentences(text);
      setSentences(newSentences);
      speakSentence(0);
    }
  };

  const handlePause = () => {
    synth.pause();
    setIsPaused(true);
    setIsPlaying(false);
  };

  const handleStop = () => {
    synth.cancel();
    setIsPlaying(false);
    setIsPaused(false);
    setCurrentSentenceIndex(0);
  };

  return (
    <div className="min-h-screen bg-neutral-50 p-4 md:p-12 font-sans text-slate-800">
      <div className="max-w-4xl mx-auto space-y-8">
        {/* Header */}
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-white p-8 rounded-3xl shadow-sm border border-neutral-200">
          <div className="flex items-center gap-5">
            <div className="bg-blue-600 p-4 rounded-2xl text-white shadow-lg shadow-blue-200">
              <BookOpen size={32} />
            </div>
            <div>
              <h1 className="text-3xl font-black tracking-tight text-slate-900">Edge ç¶²é æœ—è®€å™¨</h1>
              <p className="text-slate-500 font-medium">é›»å­æ›¸é•·æ–‡æœ¬å„ªåŒ–ç‰ˆæœ¬</p>
            </div>
          </div>
          <div className="flex gap-2">
            <div className="px-4 py-2 bg-neutral-100 rounded-full text-xs font-bold text-neutral-500 flex items-center gap-2">
              <RefreshCw size={14} /> ç€è¦½å™¨åŸç”Ÿå¼•æ“
            </div>
          </div>
        </div>

        {/* Main Interface */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Left: Input */}
          <div className="lg:col-span-2 space-y-4">
            <div className="bg-white p-2 rounded-3xl shadow-sm border border-neutral-200 min-h-[400px] flex flex-col">
              <textarea
                className="flex-1 w-full p-6 text-xl leading-relaxed outline-none resize-none rounded-2xl placeholder:text-neutral-300"
                placeholder="è«‹åœ¨æ­¤è²¼ä¸Šé›»å­æ›¸ç« ç¯€å…§å®¹..."
                value={text}
                onChange={(e) => setText(e.target.value)}
              />
              <div className="p-4 bg-neutral-50 rounded-b-2xl border-t border-neutral-100 flex justify-between items-center text-sm font-medium text-neutral-500">
                <span>ç¸½å­—æ•¸ï¼š{text.length} å­—</span>
                <span className="flex items-center gap-2"><Clock size={14} /> é è¨ˆæœ—è®€ï¼š{Math.ceil(text.length / 250)} åˆ†é˜</span>
              </div>
            </div>
          </div>

          {/* Right: Controls */}
          <div className="space-y-6">
            {/* Play Controls */}
            <div className="bg-slate-900 rounded-3xl p-6 text-white shadow-xl">
              <div className="flex flex-col gap-4">
                {!isPlaying || isPaused ? (
                  <button 
                    onClick={handlePlay}
                    className="w-full py-4 bg-blue-500 hover:bg-blue-400 rounded-2xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95 shadow-lg shadow-blue-900"
                  >
                    <Play fill="currentColor" size={20} /> é–‹å§‹æœ—è®€
                  </button>
                ) : (
                  <button 
                    onClick={handlePause}
                    className="w-full py-4 bg-amber-500 hover:bg-amber-400 rounded-2xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95"
                  >
                    <Pause fill="currentColor" size={20} /> æš«åœ
                  </button>
                )}
                <button 
                  onClick={handleStop}
                  className="w-full py-4 bg-slate-800 hover:bg-slate-700 rounded-2xl font-bold flex items-center justify-center gap-2 transition-all"
                >
                  <Square fill="currentColor" size={18} /> åœæ­¢é‡ç½®
                </button>
              </div>
            </div>

            {/* Voice Settings */}
            <div className="bg-white rounded-3xl p-6 border border-neutral-200 shadow-sm space-y-6">
              <div className="flex items-center gap-2 font-bold text-slate-800">
                <Settings size={18} /> æœ—è®€è¨­å®š
              </div>
              
              <div className="space-y-4">
                <div>
                  <label className="text-xs font-bold text-neutral-400 uppercase mb-2 block">é¸æ“‡éŸ³è‰²</label>
                  <select 
                    className="w-full p-3 rounded-xl border border-neutral-200 bg-neutral-50 text-sm outline-none focus:ring-2 focus:ring-blue-500"
                    value={selectedVoiceName}
                    onChange={(e) => setSelectedVoiceName(e.target.value)}
                  >
                    {voices.length === 0 && <option>æ­£åœ¨åŠ è¼‰èªéŸ³...</option>}
                    {/* å„ªå…ˆé¡¯ç¤ºå°ç£èˆ‡ Microsoft Online éŸ³è‰² */}
                    <optgroup label="æ¨è–¦éŸ³è‰² (Microsoft Online)">
                      {voices.filter(v => v.name.includes('Online') && v.lang.includes('zh')).map(v => (
                        <option key={v.name} value={v.name}>{v.name.replace('Microsoft ', '').replace(' Online (Natural)', '')}</option>
                      ))}
                    </optgroup>
                    <optgroup label="å…¶ä»–ç³»çµ±éŸ³è‰²">
                      {voices.filter(v => !v.name.includes('Online') && v.lang.includes('zh')).map(v => (
                        <option key={v.name} value={v.name}>{v.name}</option>
                      ))}
                    </optgroup>
                  </select>
                </div>

                <div>
                  <div className="flex justify-between text-xs font-bold text-neutral-400 mb-2">
                    <span>èªé€Ÿ ({rate}x)</span>
                  </div>
                  <input 
                    type="range" min="0.5" max="2" step="0.1" 
                    value={rate} 
                    onChange={(e) => setRate(parseFloat(e.target.value))}
                    className="w-full h-1.5 bg-neutral-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                  />
                </div>

                <div>
                  <div className="flex justify-between text-xs font-bold text-neutral-400 mb-2">
                    <span>éŸ³èª¿ ({pitch})</span>
                  </div>
                  <input 
                    type="range" min="0.5" max="2" step="0.1" 
                    value={pitch} 
                    onChange={(e) => setPitch(parseFloat(e.target.value))}
                    className="w-full h-1.5 bg-neutral-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                  />
                </div>
              </div>
            </div>

            {/* Progress Info */}
            {sentences.length > 0 && (
              <div className="bg-blue-50 rounded-3xl p-6 border border-blue-100">
                <div className="flex items-center gap-2 font-bold text-blue-900 mb-3 text-sm">
                  <List size={16} /> æœ—è®€é€²åº¦
                </div>
                <div className="text-2xl font-black text-blue-600 mb-1">
                  {Math.round(((currentSentenceIndex + 1) / sentences.length) * 100)}%
                </div>
                <div className="w-full bg-blue-200 h-2 rounded-full overflow-hidden">
                  <div 
                    className="bg-blue-600 h-full transition-all duration-500" 
                    style={{ width: `${((currentSentenceIndex + 1) / sentences.length) * 100}%` }}
                  />
                </div>
                <p className="mt-3 text-xs text-blue-700 leading-tight">
                  æ­£åœ¨è®€ï¼š{sentences[currentSentenceIndex]?.substring(0, 30)}...
                </p>
              </div>
            )}
          </div>
        </div>

        {/* Browser Notice */}
        <div className="bg-amber-50 border border-amber-100 rounded-2xl p-6 flex gap-4">
          <div className="bg-amber-100 p-2 rounded-lg text-amber-700 h-fit">
            <Info size={20} />
          </div>
          <div className="text-sm text-amber-900 leading-relaxed">
            <p className="font-bold mb-1">ğŸ’¡ å¦‚ä½•ç²å¾—æœ€ä½³é«”é©—ï¼Ÿ</p>
            <p>
              è«‹ä½¿ç”¨ <strong>Microsoft Edge ç€è¦½å™¨</strong> é–‹å•Ÿæ­¤é é¢ã€‚Edge å…§å»ºäº†å¾®è»Ÿæœ€å¼·å¤§çš„ã€Œé›²ç«¯ç¥ç¶“ç¶²è·¯èªéŸ³ã€ï¼ˆå¦‚æ›‰è‡»ã€é›²å“²ï¼‰ï¼Œé€™äº›éŸ³è‰²è½èµ·ä¾†æ¥µç‚ºåƒçœŸäººã€‚
              å¦‚æœæ‚¨ä½¿ç”¨ Chrome æˆ– Safariï¼Œç³»çµ±æœƒèª¿ç”¨ä½œæ¥­ç³»çµ±é è¨­çš„èªéŸ³ï¼ˆå¦‚ macOS çš„é›…å©·ï¼‰ï¼Œæ•ˆæœå¯èƒ½ç¨æœ‰ä¸åŒã€‚
            </p>
          </div>
        </div>
      </div>
    </div>
  );
};

export default App;
